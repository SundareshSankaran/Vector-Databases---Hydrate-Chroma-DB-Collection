{"creationTimeStamp":"2024-02-05T22:36:38.323Z","modifiedTimeStamp":"2024-02-29T19:59:25.262Z","createdBy":"viya_admin","modifiedBy":"viya_admin","name":"Gatewayed: Vector Databases - Hydrate Chroma DB Collection.step","displayName":"Gatewayed: Vector Databases - Hydrate Chroma DB Collection.step","localDisplayName":"Gatewayed: Vector Databases - Hydrate Chroma DB Collection.step","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","uri":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","uri":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","uri":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","uri":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","uri":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","uri":"/dataFlows/steps/fde99edf-9e96-491a-b291-23c6123ef7e8","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[{"name":"inputTable","displayName":"inputTable","localDisplayName":"inputTable","minEntries":1,"maxEntries":1,"defaultEntries":0,"type":"table"}],"outputPorts":[]},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"page1\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Parameters\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"input_parameters\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Input parameters\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"inputTable\",\n\t\t\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\t\t\"label\": \"Select input table:\",\n\t\t\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textVar\",\n\t\t\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\t\t\"label\": \"Select text column:\",\n\t\t\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\t\t\"min\": 1,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"table\": \"inputTable\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"docId\",\n\t\t\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\t\t\"label\": \"Select document identifier:\",\n\t\t\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\t\t\"min\": 1,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"table\": \"inputTable\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"embeddingPattern\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Provide a pattern representing your embedding columns:\",\n\t\t\t\t\t\t\t\"placeholder\": \"e.g. Col_,  var_\",\n\t\t\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"metadataColumn\",\n\t\t\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\t\t\"label\": \"Select metadata column (optional):\",\n\t\t\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\t\t\"min\": 0,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"table\": \"inputTable\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"output_specifications\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Output specifications\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"collectionName\",\n\t\t\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\t\t\"label\": \"Specify a collection name:\",\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"page2\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Configuration\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"persistentPathName\",\n\t\t\t\t\t\"type\": \"path\",\n\t\t\t\t\t\"label\": \"Select location for chroma database (defaults to /tmp):\",\n\t\t\t\t\t\"pathtype\": \"folder\",\n\t\t\t\t\t\"placeholder\": \"sasserver:/tmp\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"casHostPath\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Default CAS server hostname:\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"casHostPort\",\n\t\t\t\t\t\"type\": \"numberfield\",\n\t\t\t\t\t\"label\": \"Default CAS server port:\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"max\": null,\n\t\t\t\t\t\"min\": null,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"singleThread\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Run process in single-threaded mode\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"text2\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"Single-threaded is recommended for 'small data' situations where initialization and synchronization overhead from using multiple threads might not be productive.  \",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"about\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"about_description\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"Vector Databases - Hydrate a Chroma DB Collection (Gateway-ed)\\n\\nThis custom step populates a Chroma vector database collection with documents and embeddings contained in a SAS Cloud Analytics Services (CAS) table.\\n\\nVector databases facilitate many Generative AI applications, particularly in providing context to a Large Language Model (LLM).  Examples of other applications include recommendation engines, similarity search and time series forecasting. \\n\\nChroma is an open-source vector database used in Generative AI pipelines.  It shares many similar constructs and concepts with other vector store offerings. \",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"about_parameters\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Parameters\",\n\t\t\t\t\t\"open\": 0,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"section1\",\n\t\t\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\t\t\"label\": \"Assumptions \",\n\t\t\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\"id\": \"parameters_text\",\n\t\t\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\t\t\"text\": \"1.  For this initial version, your input data requires a text variable, a set of document embeddings (columns) and optionally, an additional categorical variable for metadata.  We plan to accommodate additional variables in future versions.\\n\\n2.  Chroma DB follows client / server architecture.  This step implicitly considers the client and server to be on the same machine (see comments in code).  Users are free to modify the step for persistent, remote/external, or alternatively orchestrated (e.g. Docker container) servers based on their requirement.  Chroma DB documentation provides some examples (refer Documentation).\\n\\n3. While embeddings are typically created using either SAS Visual Text Analytics (VTA) or Visual Data Mining and Machine Learning (VDMML), this custom step does not strictly require a VTA/VDMML license since it only makes use of the output from those applications.  \\n\\n4.  This custom step runs on data loaded to a SAS Cloud Analytics Services (CAS) library (known as a caslib). Ensure you are connected to CAS before running this step. \\n\\n5.  Proc Python is required.  Details on Python packages in prerequisites section below.  Also, consider build and install of  Python and required packages through the SAS Configurator for Open Source.\\n\\n6.  Many vector databases (Chroma included), can auto-generate embeddings on ingested text data (documents), using either proprietary or open-source embedding models.  This custom step highlights the integration of SAS Viya-generated embeddings (from VTA / VDMML) with vector databases and therefore requires embeddings to be provided as part of input data.  A future version will examine how to auto-generate embeddings through the step. \",\n\t\t\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"section2\",\n\t\t\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\t\t\"label\": \"Prerequisites\",\n\t\t\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\"id\": \"text1\",\n\t\t\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\t\t\"text\": \"1. A SAS Viya 4 environment version 2023.12 or later.\\n\\n2. Python packages to be installed:\\n\\n   i.   chromadb\\n   ii.  pysqlite-binary\\n   iii. pandas\\n   iv. swat\\n   v.  transformers(optional) \\n\\n3. Suggested Python version is 3.10.x due to dependency on sqlite version >= 3.35.0 (refer documentation).  However, a workaround suggested by Chroma has been followed in the code.\\n\\n4. Optional components, based on site-specific architecture, are to have a separate Chroma DB server for persistence and scale.  Refer Chroma documentation for details.\",\n\t\t\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"parameters_input\",\n\t\t\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\t\t\"label\": \"Input parameters\",\n\t\t\t\t\t\t\t\"open\": 1,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\"id\": \"input_parameters_text\",\n\t\t\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\t\t\"text\": \"1. Input table containing a text column (input port, required): attach a CAS table to this port.\\n\\n2. Text column (column selector, required, maximum 1): select a text column which your embeddings represent.\\n\\n3.  Document identifier (column selector, required, maximum 1): select a column which serves as a unique identifier for your observation.\\n\\n4. Embedding pattern (text column, required):  document embeddings tend to be long series involving 100s or sometimes 1000s of columns.  To avoid having to select them individually, provide a text pattern which applies to all embedding column names. For example,  Col_ represents Col_1, Col_2..... Col_n.\\n\\n5. Metadata column (optional, column selector, maximum 1): select a column which contains additional metadata (for example, a category, sentiment or star rating) which is also ingested into the vector database collection.\\n\",\n\t\t\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"parameters_config_1\",\n\t\t\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\t\t\"label\": \"Configuration \",\n\t\t\t\t\t\t\t\"open\": 1,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\"id\": \"output_parameters_text_1\",\n\t\t\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\t\t\"text\": \"1. Location for Chroma database (folder selector, required): select a location to persist the Chroma database.  Note this needs to be on the filesystem (SAS Server) and not SAS Content.  In case no value is provided, the path defaults to /tmp.  Note that /tmp gets cleared upon termination of the SAS compute session. \\n\\n2. CAS server (text field, default entered): change this only if you need a CAS server name different from a typical Viya 4 installation.\\n\\n3. CAS port (numeric field, default entered): change this only if you know that the CAS server runs on a different port than the default.\",\n\t\t\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"parameters_output_specs\",\n\t\t\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\t\t\"label\": \"Output specifications\",\n\t\t\t\t\t\t\t\"open\": 1,\n\t\t\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\"id\": \"output_parameters_text\",\n\t\t\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\t\t\"text\": \"- Name of collection (text column, required): provide a name for your collection.  A vector database collection can be viewed as similar to a table in a relational database.\\n\\nUpon successful completion, an informational message is written to the log indicating number of records loaded.\",\n\t\t\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"about_runtimecontrol\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Run-time Control\",\n\t\t\t\t\t\"open\": 0,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"runtimecontrol_text\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"Note: Run-time control is optional.  You may choose whether to execute the main code of this step or not, based on upstream conditions set by earlier SAS programs.  This includes nodes run prior to this custom step earlier in a SAS Studio Flow, or a previous program in the same session.\\n\\nRefer this blog (https://communities.sas.com/t5/SAS-Communities-Library/Switch-on-switch-off-run-time-control-of-SAS-Studio-Custom-Steps/ta-p/885526) for more details on the concept.\\n\\nThe following macro variable,\\n\\n_hcdc_run_trigger\\n\\nwill initialize with a value of 1 by default, indicating an \\\"enabled\\\" status and allowing the custom step to run.\\n\\nIf you wish to control execution of this custom step, include code in an upstream SAS program to set this variable to 0.  This \\\"disables\\\" execution of the custom step.\\n\\nTo \\\"disable\\\" this step, run the following code upstream:\\n\\n%global _hcdc_run_trigger;\\n%let _hcdc_run_trigger =0;\\n\\nTo \\\"enable\\\" this step again, run the following (it's assumed that this has already been set as a global variable):\\n\\n%let _hcdc_run_trigger =1;\\n\\nIMPORTANT: Be aware that disabling this step means that none of its main execution code will run, and any  downstream code which was dependent on this code may fail.  Change this setting only if it aligns with the objective of your SAS Studio program.\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"about_documentation\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Documentation\",\n\t\t\t\t\t\"open\": 0,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"documentation_text\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"1. Documentation for the chromadb Python package: https://docs.trychroma.com\\n\\n2. An important note regarding sqlite: https://docs.trychroma.com/troubleshooting#sqlite\\n\\n3. SAS Communities article on configuring Viya for Python integration: https://communities.sas.com/t5/SAS-Communities-Library/Configuring-SAS-Viya-for-Python-Integration/ta-p/847459\\n\\n4. The SAS Viya Platform Deployment Guide (refer to SAS Configurator for Open Source within): https://go.documentation.sas.com/doc/en/itopscdc/default/itopssr/p1n66p7u2cm8fjn13yeggzbxcqqg.htm?fromDefault=#p19cpvrrjw3lurn135ih46tjm7oi \\n\\n5.  Options for persistent clients and client connections in Chroma: https://docs.trychroma.com/usage-guide\\n\\n6.  Every custom step is a learning opportunity for SAS programming!  I revisited the venerable but still powerful DATALINES (DATALINES4) statement and it proved helpful in negotiating a design challenge in the SAS program.  Documentation: https://go.documentation.sas.com/doc/en/pgmsascdc/default/lestmtsref/p1mm9b070wj962n16q0v1d9uku5q.htm\\n\\n7. SAS Communities article on connecting to CAS using the SWAT package in SAS Studio: https://communities.sas.com/t5/SAS-Communities-Library/Hotwire-your-SWAT-inside-SAS-Studio/ta-p/835956\\n\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"version_text\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"Version: 1.0  (29FEB2024)\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"contact_text\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"Created/contact: \\n\\n- Sundaresh Sankaran (sundaresh.sankaran@sas.com)\\n\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"inputTable\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"textVar\": [],\n\t\t\"docId\": [],\n\t\t\"embeddingPattern\": \"\",\n\t\t\"metadataColumn\": [],\n\t\t\"collectionName\": \"\",\n\t\t\"persistentPathName\": \"\",\n\t\t\"casHostPath\": \"sas-cas-server-default-client\",\n\t\t\"casHostPort\": 5570,\n\t\t\"singleThread\": false\n\t}\n}","templates":{"SAS":"/* templated code goes here*/;\n\n/* -----------------------------------------------------------------------------------------* \n   Vector Databases - Hydrate Chroma DB Collection\n\n   Version: 2.0 (22FEB2024)\n   Created: Sundaresh Sankaran(sundaresh.sankaran@sas.com)\n    \n   Available at: \n   https://github.com/SundareshSankaran/Vector-Databases---Hydrate-Chroma-DB-Collection\n*------------------------------------------------------------------------------------------ */\n\n/*-----------------------------------------------------------------------------------------*\n   START MACRO DEFINITIONS.\n*------------------------------------------------------------------------------------------*/\n\n/* -----------------------------------------------------------------------------------------* \n   Macro to create an error flag for capture during code execution.\n\n   Input:\n      1. errorFlagName: The name of the error flag you wish to create. Ensure you provide a \n         unique value to this parameter since it will be declared as a global variable.\n      2. errorFlagDesc: The name of an error flag description variable to hold the error \n         description.\n\n    Output:\n      1. &errorFlagName : A global variable which takes the name provided to errorFlagName.\n      2. &errorFlagDesc : A global variable which takes the name provided to errorFlagDesc.\n\n   Also available at: \n   https://github.com/SundareshSankaran/sas_utility_programs/blob/main/code/Error%20Flag%20Creation/macro_create_error_flag.sas\n*------------------------------------------------------------------------------------------ */\n\n%macro _create_error_flag(errorFlagName, errorFlagDesc);\n\n   %global &errorFlagName.;\n   %let  &errorFlagName.=0;\n\n   %global &errorFlagDesc.;\n   %let  &errorFlagDesc.=0;\n\n%mend _create_error_flag;\n\n\n/* -------------------------------------------------------------------------------------------* \n   Macro to initialize a run-time trigger global macro variable to run SAS Studio Custom Steps. \n   A value of 1 (the default) enables this custom step to run.  A value of 0 (provided by \n   upstream code) sets this to disabled.\n\n   Input:\n   1. triggerName: The name of the runtime trigger you wish to create. Ensure you provide a \n      unique value to this parameter since it will be declared as a global variable.\n\n   Output:\n   1. &triggerName : A global variable which takes the name provided to triggerName.\n   \n   Also available at:\n   https://github.com/SundareshSankaran/sas_utility_programs/blob/main/code/Create_Run_Time_Trigger/macro_create_runtime_trigger.sas\n*-------------------------------------------------------------------------------------------- */\n\n%macro _create_runtime_trigger(triggerName);\n\n   %global &triggerName.;\n\n   %if %sysevalf(%superq(&triggerName.)=, boolean)  %then %do;\n  \n      %put NOTE: Trigger macro variable &triggerName. does not exist. Creating it now.;\n      %let &triggerName.=1;\n\n   %end;\n\n%mend _create_runtime_trigger;\n\n\n\n\n\n/*-----------------------------------------------------------------------------------------*\n   Macro to capture indicator and UUIDof any currently active CAS session.\n   UUID is not expensive and can be used in future to consider graceful reconnect.\n\n   Input:\n   1. errorFlagName: name of an error flag that gets populated in case the connection is \n                     not active. Provide this value in quotes when executing the macro.\n                     Define this as a global macro variable in order to use downstream.\n   2. errorFlagDesc: Name of a macro variable which can hold a descriptive message output\n                     from the check.\n                     \n   Output:\n   1. Informational note as required. We explicitly don't provide an error note since \n      there is an easy recourse(of being able to connect to CAS)\n   2. UUID of the session: macro variable which gets created if a session exists.\n   3. errorFlagName: populated\n   4. errorFlagDesc: populated\n*------------------------------------------------------------------------------------------*/\n\n%macro _env_cas_checkSession(errorFlagName, errorFlagDesc);\n    %if %sysfunc(symexist(_current_uuid_)) %then %do;\n       %symdel _current_uuid_;\n    %end;\n    %if %sysfunc(symexist(_SESSREF_)) %then %do;\n      %let casSessionExists= %sysfunc(sessfound(&_SESSREF_.));\n      %if &casSessionExists.=1 %then %do;\n         %global _current_uuid_;\n         %let _current_uuid_=;   \n         proc cas;\n            session.sessionId result = sessresults;\n            call symputx(\"_current_uuid_\", sessresults[1]);\n         quit;\n         %put NOTE: A CAS session &_SESSREF_. is currently active with UUID &_current_uuid_. ;\n         data _null_;\n            call symputx(&errorFlagName., 0);\n            call symput(&errorFlagDesc., \"CAS session is active.\");\n         run;\n      %end;\n      %else %do;\n         %put NOTE: Unable to find a currently active CAS session. Reconnect or connect to a CAS session upstream. ;\n         data _null_;\n            call symputx(&errorFlagName., 1);\n            call symput(&errorFlagDesc., \"Unable to find a currently active CAS session. Reconnect or connect to a CAS session upstream.\");\n        run;\n      %end;\n   %end;\n   %else %do;\n      %put NOTE: No active CAS session ;\n      data _null_;\n        call symputx(&errorFlagName., 1);\n        call symput(&errorFlagDesc., \"No active CAS session. Connect to a CAS session upstream.\");\n      run;\n   %end;\n%mend _env_cas_checkSession;\n\n\n/*-----------------------------------------------------------------------------------------*\n   This macro creates a global macro variable called _usr_nameCaslib\n   that contains the caslib name (aka. caslib-reference-name) associated with the libname \n   and assumes that the libname is using the CAS engine.\n\n   As sysvalue has a length of 1024 chars, we use the trimmed option in proc sql\n   to remove leading and trailing blanks in the caslib name.\n   From macro provided by Wilbram Hazejager\n*------------------------------------------------------------------------------------------*/\n\n%macro _usr_getNameCaslib(_usr_LibrefUsingCasEngine); \n\n   %global _usr_nameCaslib;\n   %let _usr_nameCaslib=;\n\n   proc sql noprint;\n      select sysvalue into :_usr_nameCaslib trimmed from dictionary.libnames\n      where libname = upcase(\"&_usr_LibrefUsingCasEngine.\") and upcase(sysname)=\"CASLIB\";\n   quit;\n\n%mend _usr_getNameCaslib;\n\n\n/* ------------------------------------------------------------------------------------------------* \n   Macro to check whether a path to Python is available to a compute \n   session where this program runs.  Detailed macro available at \n   https://github.com/SundareshSankaran/sas_utility_programs/blob/main/code/Check_For_Python/macro_python_check.sas\n\n   Sundaresh Sankaran, 20FEB2024\n*----------------------------------------------------------------------------------------------------- */\n\n/* ----------------------------------------------------------------------------------------------* \n   This macro carries out the check in a Compute server.  If you already know you are running this \n   code in a Compute server session, you can call the %_env_check_python_compute macro directly.\n*----------------------------------------------------------------------------------------------- */\n\n%macro _env_check_python_compute(errorFlagName, errorFlagDesc);\n\n   data _null_;\n      /* ----------------------------------------------------------------------------------------------* \n         Obtain system options and store them inside macro variables.\n         Note: if the environment variable does not exist, sysget throws a NOTE with _ERROR_ populated.\n      *----------------------------------------------------------------------------------------------- */\n      proc_pypath = sysget('PROC_PYPATH');\n      viya_lockdown_user_methods = sysget('VIYA_LOCKDOWN_USER_METHODS');\n      compute_enable = sysget('COMPUTESERVER_LOCKDOWN_ENABLE');\n      does_file_at_pypath_exist=fileexist(proc_pypath);\n\n      /* ----------------------------------------------------------------------------------------------* \n         Let's start from the end\n         Check if PROC_PYPATH exists\n      *----------------------------------------------------------------------------------------------- */\n\n      if proc_pypath = \"\" then do;\n         call symputx(&errorFlagName.,1);\n         call symput(&errorFlagDesc., \"PROC_PYPATH environment variable not populated, indicating that Python may not have been configured.\");\n      end;\n      else do;\n         /* -------------------------------------------------------------------------------------------* \n            Check if PROC_PYPATH points to a valid file\n         *-------------------------------------------------------------------------------------------- */\n         if does_file_at_pypath_exist = 0 then do;\n            call symputx(&errorFlagName.,1);\n            call symput(&errorFlagDesc., \"The file referred by PROC_PYPATH does not exist, indicating path to Python may have been configured incorrectly.\");             \n         end;\n         else do;\n            /* -----------------------------------------------------------------------------------------* \n               Check if COMPUTESERVER_LOCKDOWN_ENABLE = 0, indicating a permissive (and potentially \n               insecure) environment.\n            *------------------------------------------------------------------------------------------ */\n            if compute_enable = '1' then do;\n               /* --------------------------------------------------------------------------------------* \n                  Check if PYTHON and SOCKET appear in viya_lockdown_user_methods.\n                  There's an additional PYTHON_EMBED option which is included as a strict check (enabling \n                  Python to run in a submit block).\n               *--------------------------------------------------------------------------------------- */\n               if index(lowcase(viya_lockdown_user_methods),\"python\") > 0 and index(lowcase(viya_lockdown_user_methods),\"socket\") > 0 and index(lowcase(viya_lockdown_user_methods),\"python_embed\") > 0 then do;\n                  call symput(\"PROC_PYPATH\", proc_pypath);\n                  call symputx(&errorFlagName.,0);\n                  call symput(&errorFlagDesc., \"A path to Python is available in this compute session and Python use is part of Viya enabled methods.\") ;\n               end;\n               else do;\n                  call symputx(&errorFlagName.,1);\n                  call symput(&errorFlagDesc., \"Required access methods to run Python don't seem to form part of the user methods allowed in Viya. Please take steps to enable PYTHON, PYTHON_EMBED and SOCKET\");             \n               end;\n            end;\n            else do;\n               call symput(\"PROC_PYPATH\", proc_pypath);\n               call symputx(&errorFlagName.,0);\n               call symput(&errorFlagDesc., \"A path to Python is available in this compute session and COMPUTESERVER_LOCKDOWN_ENABLE is disabled. While you can run Python, note that setting COMPUTESERVER_LOCKDOWN_ENABLE to 0 is not recommended.\");\n            end;\n         end;\n      end;\n   run;\n%mend _env_check_python_compute;\n\n\n/* -----------------------------------------------------------------------------------------* \n   Macro to identify whether a given folder location provided from a \n   SAS Studio Custom Step folder selector happens to be a SAS Content folder\n   or a folder on the filesystem (SAS Server).\n\n   Input:\n   1. pathReference: A path reference provided by the file or folder selector control in \n      a SAS Studio Custom step.\n\n   Output:\n   1. _path_identifier: Set inside macro, a global variable indicating the prefix of the \n      path provided.\n\n   Also available at: https://raw.githubusercontent.com/SundareshSankaran/sas_utility_programs/main/code/Identify%20SAS%20Content%20or%20Server/macro_identify_sas_content_server.sas\n\n*------------------------------------------------------------------------------------------ */\n\n%macro _identify_content_or_server(pathReference);\n   %global _path_identifier;\n   data _null_;\n      call symput(\"_path_identifier\", scan(\"&pathReference.\",1,\":\",\"MO\"));\n   run;\n   %put NOTE: _path_identifier is &_path_identifier. ;\n%mend _identify_content_or_server;\n\n\n/* -----------------------------------------------------------------------------------------* \n   Macro to extract the path provided from a SAS Studio Custom Step file or folder selector.\n\n   Input:\n   1. pathReference: A path reference provided by the file or folder selector control in \n      a SAS Studio Custom step.\n\n   Output:\n   1. _sas_folder_path: Set inside macro, a global variable containing the path.\n\n   Also available at: https://raw.githubusercontent.com/SundareshSankaran/sas_utility_programs/main/code/Extract%20SAS%20Folder%20Path/macro_extract_sas_folder_path.sas\n\n*------------------------------------------------------------------------------------------ */\n\n%macro _extract_sas_folder_path(pathReference);\n   %global _sas_folder_path;\n   data _null_;\n      call symput(\"_sas_folder_path\", scan(\"&pathReference.\",2,\":\",\"MO\"));\n   run;\n%mend _extract_sas_folder_path;\n\n\n/*-----------------------------------------------------------------------------------------*\n   EXECUTION CODE MACRO (FOR PREFLIGHT ACTIVITIES ONLY)\n   Note that due to the limitation of proc cas externalsource statements operating within \n   a macro, this macro is called along with additional execution code.\n*------------------------------------------------------------------------------------------*/\n\n%macro _hcdc_pf_execution_code;\n\n/*-----------------------------------------------------------------------------------------*\n   Create an error flag. \n*------------------------------------------------------------------------------------------*/\n\n   %_create_error_flag(_hcdc_error_flag, _hcdc_error_desc);\n\n\n/*-----------------------------------------------------------------------------------------*\n   Check if Python's available in the environment. \n*------------------------------------------------------------------------------------------*/\n\n   %_env_check_python_compute(\"_hcdc_error_flag\",\"_hcdc_error_desc\");\n\n/*-----------------------------------------------------------------------------------------*\n   Check if an active CAS session exists. \n*------------------------------------------------------------------------------------------*/\n\n/*-----------------------------------------------------------------------------------------*\n   Macro variable to capture indicator of a currently active CAS session\n*------------------------------------------------------------------------------------------*/\n\n   %global casSessionExists;\n   %global _current_uuid_;\n\n   %if &_hcdc_error_flag.=0 %then %do;\n      %_env_cas_checkSession(\"_hcdc_error_flag\", \"_hcdc_error_desc\");\n   %end;\n   %else %if &_hcdc_error_flag.=1 %then %do;\n      %put ERROR: &_hcdc_error_desc. ;\n   %end;\n/*-----------------------------------------------------------------------------------------*\n   Note that above error = 1 block will print errors encountered in previous step.\n*------------------------------------------------------------------------------------------*/\n\n/*-----------------------------------------------------------------------------------------*\n   Check Input table libref to ensure it points to a valid caslib.\n*------------------------------------------------------------------------------------------*/\n\n   %if &_hcdc_error_flag. = 0 %then %do;\n\n      %global inputCaslib;\n   \n      %_usr_getNameCaslib(&inputTable_lib.);\n      %let inputCaslib=&_usr_nameCaslib.;\n      %put NOTE: &inputCaslib. is the caslib for the input table.;\n      %let _usr_nameCaslib=;\n\n      %if \"&inputCaslib.\" = \"\" %then %do;\n         %put ERROR: Library selected for input table needs to point to a caslib. ;\n         %let _hcdc_error_flag=1;\n      %end;\n\n   %end;\n   %else %if &_hcdc_error_flag.=1 %then %do;\n      %put ERROR: &_hcdc_error_desc. ;\n   %end;\n\n/*-----------------------------------------------------------------------------------------*\n   Check if path provided happens to be a filesystem (SAS Server) or SAS Content path. \n   Prior to that, insert /tmp as a placeholder in case this field has not been entered.\n*------------------------------------------------------------------------------------------*/\n\n   %if &_hcdc_error_flag. = 0 %then %do;\n\n      %if \"&persistentPathName.\"=\"\" %then %do;\n         %let persistentPathName=sasserver:/tmp;\n      %end;\n      %else %do;\n         %_identify_content_or_server(&persistentPathName.);\n         %if \"&_path_identifier.\"=\"sasserver\" %then %do;\n            %put NOTE: Folder location prefixed with &_path_identifier. is on the SAS Server.;\n         %end;\n         %else %do;\n            %let _hcdc_error_flag=1;\n            %put ERROR: Please select a valid folder on the SAS Server for persisting the database. ;\n         %end;\n      %end;\n\n   %end;\n   %else %if &_hcdc_error_flag.=1 %then %do;\n      %put ERROR: &_hcdc_error_desc. ;\n   %end;\n\n/*-----------------------------------------------------------------------------------------*\n   Extract path from the UI macro variable provided.\n*------------------------------------------------------------------------------------------*/\n   %if &_hcdc_error_flag. = 0 %then %do;\n      %global persistentPath;\n      %_extract_sas_folder_path(&persistentPathName.);\n      %let persistentPath = &_sas_folder_path.;\n      %let _sas_folder_path=;\n   %end;\n   %else %if &_hcdc_error_flag.=1 %then %do;\n      %put ERROR: &_hcdc_error_desc. ;\n   %end;\n\n/*-----------------------------------------------------------------------------------------*\n   Execution code follows in a proc cas block with python code submitted as part of an \n   externalsource statement.\n\n*------------------------------------------------------------------------------------------*/\n\n%mend _hcdc_pf_execution_code;\n\n/*-----------------------------------------------------------------------------------------*\n   END MACRO DEFINITIONS\n*------------------------------------------------------------------------------------------*/\n\n/*-----------------------------------------------------------------------------------------*\n   EXECUTION CODE\n   The execution code is controlled by the trigger variable defined in this custom step. This\n   trigger variable is in an \"enabled\" (value of 1) state by default, but in some cases, as \n   dictated by logic, could be set to a \"disabled\" (value of 0) state.\n*------------------------------------------------------------------------------------------*/\n/*-----------------------------------------------------------------------------------------*\n   Create run-time trigger. \n*------------------------------------------------------------------------------------------*/\n\n%_create_runtime_trigger(_hcdc_run_trigger);\n\n%if &_hcdc_run_trigger. = 0 %then %do;\n\n   %put NOTE: This step has been disabled.  Nothing to do.;\n\n%end;\n\n%_hcdc_pf_execution_code;\n\nproc cas;\n\n/*-----------------------------------------------------------------------------------------*\n   Note that Python indentation may not be in line with SAS indentation.\n*------------------------------------------------------------------------------------------*/\n\nexternalsource chromcode;\n\n#############################################################################################\n#\n#  Set logging levels to suppress unnecessary messages from specific modules\n#\n#############################################################################################\n\nimport logging\n\nhnsw_log = logging.getLogger(\"chromadb.segment.impl.vector.local_persistent_hnsw\")\nhnsw_log.setLevel( logging.ERROR)\nsqlite_log = logging.getLogger(\"chromadb.segment.impl.metadata.sqlite\")\nsqlite_log.setLevel( logging.ERROR)\n\n#############################################################################################\n#\n#  The pysqlite3 import allows for the code to also run in (some) older Python (or sqlite) versions.\n#\n#############################################################################################\n\n__import__('pysqlite3')\nimport sys\nsys.modules['sqlite3'] = sys.modules.pop('pysqlite3')\n\nimport os\nos.environ['ANONYMIZED_TELEMETRY'] = \"False\"\n\ntry:\n   import chromadb\nexcept ImportError as ie:\n   SAS.logMessage(ie,\"error\")\n   \n#############################################################################################\n#\n#  Helper functions\n#\n#############################################################################################\n\ndef load_with_metadata():\n   collection.add(\n      ids=[str(i) for i in scoredTable[gateway.args['document_id']]],  \n      documents=[doc for doc in scoredTable[gateway.args['text_variable']]],\n      embeddings=[embedding for embedding in df[\"Embeddings\"]],\n      metadatas=[{\"rating\": target} for target in scoredTable[gateway.args['metadata_column']]],\n   )\n   print(\"The number of records inserted: {}\".format(scoredTable.shape[0]))\n\n\ndef load_without_metadata():\n   collection.add(\n      ids=[str(i) for i in scoredTable[gateway.args['document_id']]],  \n      documents=[doc for doc in scoredTable[gateway.args['text_variable']]],\n      embeddings=[embedding for embedding in df[\"Embeddings\"]]\n   )\n   print(\"The number of records inserted: {}\".format(scoredTable.shape[0]))\n\n\ndef on_all_threads():\n   try:\n      print(\"Chroma client alive at: {}\".format(chroma_client.heartbeat()))\n      print(\"on thread {}\".format(gateway.thread_id))\n      df['Embeddings'] = (scoredTable.filter(like=gateway.args['embedding_pattern']).apply(lambda row: row.dropna().tolist(), axis=1))      \n      if gateway.args[\"metadata_column\"] in scoredTable.columns:\n         load_with_metadata()\n      else:\n         load_without_metadata()\n   except Exception as e:\n      print(e)\n      \n#############################################################################################\n#\n#  Read table to load into database\n#\n#############################################################################################\n\nscoredTable = gateway.read_table({'caslib': gateway.args['input_table_lib'], 'name': gateway.args['input_table_name']})\n\nimport re\nimport pandas\ndf = pandas.DataFrame()\n\n#############################################################################################\n#\n#  Connect to Chroma DB & hydrate \n#\n#############################################################################################\n\nchroma_client = chromadb.PersistentClient(path=gateway.args['persistent_path'])\n\nif gateway.thread_id == 0:\n   collection = chroma_client.get_or_create_collection(name=gateway.args['collection_name'])\nelse:\n   import time\n   time.sleep(0.15)\n   collection = chroma_client.get_collection(name=gateway.args['collection_name'])\n\non_all_threads()\n\nprint(collection.count())\n\n   endexternalsource;\n\n/*-----------------------------------------------------------------------------------------*\n   Obtain values from UI\n*------------------------------------------------------------------------------------------*/\n   _hcdc_error_flag     = symget(\"_hcdc_error_flag\");\n   inputCaslib          = symget(\"inputCaslib\");\n   persistentPath       = symget(\"persistentPath\");\n   collectionName       = symget(\"collectionName\");\n   inputTable_name_base = symget(\"inputTable_name_base\");\n   docId                = symget(\"docId\");\n   textVar              = symget(\"textVar\");\n   embedding_pattern    = symget(\"embeddingPattern\");\n   metadataColumn       = symget(\"metadataColumn\");\n\n/*-----------------------------------------------------------------------------------------*\n   Create run-time trigger. \n*------------------------------------------------------------------------------------------*/\n\n   if _hcdc_error_flag = '0' then do;\n    \n   print metadataColumn;\n\n      gateway.runLang /\n         code = chromcode,\n         language = 'PYTHON',\n         single = true,\n         args = {\n\n          input_table_lib   = inputCaslib,\n          input_table_name  = inputTable_name_base,\n          embedding_pattern = embedding_pattern, \n          collection_name   = collectionName, \n          persistent_path   = persistentPath,\n          document_id       = docId,\n          text_variable     = textVar,\n          metadata_column   = metadataColumn\n\n         }\n      ;\n\n   end;\n\n   \nquit;\n\n/*-----------------------------------------------------------------------------------------*\n   Clean up existing macro variables and macro definitions.\n*------------------------------------------------------------------------------------------*/\n%if %symexist(_hcdc_error_flag) %then %do;\n   %symdel _hcdc_error_flag;\n%end;\n\n%if %symexist(_hcdc_error_desc) %then %do;\n   %symdel _hcdc_error_desc;\n%end;\n\n%if %symexist(casSessionExists) %then %do;\n   %symdel casSessionExists;\n%end;\n\n%if %symexist(inputCaslib) %then %do;\n   %symdel inputCaslib;\n%end;\n\n%if %symexist(persistentPath) %then %do;\n   %symdel persistentPath;\n%end;\n\n%if %symexist(PROC_PYPATH) %then %do;\n   %symdel PROC_PYPATH;\n%end;\n\n%if %symexist(_current_uuid_) %then %do;\n   %symdel _current_uuid_;\n%end;\n\n%if %symexist(_sas_folder_path) %then %do;\n   %symdel _sas_folder_path;\n%end;\n\n%if %symexist(_path_identifier) %then %do;\n   %symdel _path_identifier;\n%end;\n\n%if %symexist(_hcdc_run_trigger) %then %do;\n   %symdel _hcdc_run_trigger;\n%end;\n\n\n/*-----------------------------------------------------------------------------------------*\n   Clean up existing macro variables and macro definitions.\n*------------------------------------------------------------------------------------------*/\n%sysmacdelete _hcdc_pf_execution_code;\n%sysmacdelete _env_check_python_compute;\n%sysmacdelete _usr_getNameCaslib;\n%sysmacdelete _env_cas_checkSession;\n%sysmacdelete _extract_sas_folder_path;\n%sysmacdelete _identify_content_or_server;\n%sysmacdelete _create_runtime_trigger;\n%sysmacdelete _create_error_flag;\n\n"}}